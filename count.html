<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="Content-Language" content="en">
    <meta name="viewport" content="initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>Count</title>
    <link rel="stylesheet" type="text/css" href="assets/common.css?111">

    <style>
        body {
            /* Disables pull-to-refresh but allows overscroll glow effects. */
            overscroll-behavior-y: contain;
        }

        body { background: #eee; }
        .score, .gifts { background: #390; }
        .score .bar { background: #5c3; }
        
        .prompticonsuccess { display: none; }
        body .prompt.success .prompticonsuccess { display: inline; }
        body .prompt.success .prompticon { display: none; }

        .prompt .infield {
            background: #fffae4;
            font-size: 3rem;
            padding: 0 .6rem;
            letter-spacing: .1rem;
            height: 8.5rem;
        }
        
        .prompt .infield .inp { color: #000; }
        body .prompt.success .infield .inp { color: #090; }
        
        .prompt .ph {
            color: #00b;
            font-family: Times New Roman, serif;
            font-style: italic;
        }
        
        .op { display: inline-block; padding: 0 .4rem; }        
        .cmpop { display: inline-block; padding: 0 .8rem; }

        .keypad td {
            border-top: .5rem solid #d5d;
            border-left: .5rem solid #d5d;
            border-right: .5rem solid #707;
            border-bottom: .5rem solid #707;
            background: #a3a;
            color: #fff;
            font-size: 3rem;
            width: 20%;
            text-align: center;
            margin: 0;
        }
        .keypad td.pressed {
            border-top: .5rem solid #707;
            border-left: .5rem solid #707;
            border-right: .5rem solid #d5d;
            border-bottom: .5rem solid #d5d;
            background: #929;
            color: #ddd;
        }
        
        .hintwrap {
            min-height: 4rem;
            margin: 1rem 0;
            overflow: auto;
        }
        table.hint { 
            border-collapse: collapse; 
        }
        table.hint td {
            border: 2px solid #000;
            padding: .1rem .1rem;
            font-size: .9rem;
        }
        table.hint td.hint-h {
            background: #0f0;
        }
        table.hint td.wide {
            height: 2.5rem;
            vertical-align: top;
        }
        table.hint td.wide div {
            transform: rotate(80deg);
            width: 1rem;
        }

    </style>

    <script src="assets/fireworks/fireworks.js"></script>
    <script src="assets/confetti/js-confetti.browser.js"></script>
    <script src="assets/jquery/jquery-3.7.1.min.js"></script>
    <script src="assets/local/beelocal.js?111"></script>
</head>
<body>
    <div class="container">

        <div class="game scorewrap">
            <div class="score">
                <span class="icon">ü™ô</span> <span class="value">0</span>
                <div class="bar"><span class="barfill"></span></div>
            </div><div class="gifts"><span class="open">üéÅ</span><span class="close">X</span><span class="needed">-</span></div>
        </div>
        <div class="game prompt">
            <div class="infield">
                <div class="problem"></div>
                <div><span class="prompticon"></span><span class="prompticonsuccess"></span> <span class="prompt-ph"><span class="ph">a</span><span class="cmpop">=</span></span><span class="inp"></span></div>
            </div>
            <div class="hintwrap">
                <div class="hintloader"><img src="assets/images/loader.gif"></div>
                <table class="hint"></table>
            </div>
        </div>

        <table class="game keypad">
        <tr>
            <td data-i="D7">7</td>
            <td data-i="D8">8</td>
            <td data-i="D9">9</td>
            <td data-i="del">üîô</td>
        </tr>
        <tr>
            <td data-i="D4">4</td>
            <td data-i="D5">5</td>
            <td data-i="D6">6</td>
            <td data-i=""></td>
        </tr>
        <tr>
            <td data-i="D1">1</td>
            <td data-i="D2">2</td>
            <td data-i="D3">3</td>
            <td data-i="help">‚ùì</td>
        </tr>
        <tr>
            <td data-i="D-">-</td>
            <td data-i="D0">0</td>
            <td data-i="half">¬Ω</td>
            <td data-i="ent">üÜó</td>
        </tr>
        </table>

        <div class="startmenu"></div>
        
        <div class="giftlist">
            <span class="title">Gifts collected</span>
            <div class="list">
                <img src="assets/images/nogift.png">
                <span class="next">Next</span>
                <span class="exchange">Exchange<br>ü™ôü™ô</span>
            </div>
        </div>

        <div class="giftannounce">
            <span></span>
            <img src="assets/images/nogift.png">
        </div>

    </div>
    <p class="smallprint">
    v<span class="d_version"></span>
    Player: <span class="d_player"></span>
    | Problem range: <span class="d_wordsets"></span>
    | <span class="handle">Licences</span>
    <span class="expand"></span> 
    | Icons by <a href="https://icons8.com">Icons8</a>
    | <a href="https://codeberg.org/csirmaz/learning-aid">Codebase</a>
    | <a href="#" onclick="bee_tts.speak('This is what text to speach sounds like: '+Math.floor(Math.random()*100), function(){ alert(bee_tts.voice.name+' '+bee_tts.voice.lang+' '+bee_tts.voice.localService); }); return false">TTS</a>
    <span class="localfunctions"></span>
    | <a href="#" onclick="window.location.reload(true); return false">Switch player</a>
    | <a href="#" onclick="modify_problemset(); return false">Update problem range</a>
    | <a href="#" onclick="reduce_score(); return false">Reduce score</a>
    </p>
    <p class="smallprint">Hint: Press F1, F2, ESC or the button under ESC (some may trigger other functions)</p>

    <div class="fireworks-container"></div>
    
    <script>
    
        const max_problemset = 1;
        const MAX_INPUT = 6;
        const HALF = '¬Ω';
        
        function RND(min, max) { return min + Math.floor(Math.random() * (max + 1 - min)); } // inclusive
        
        function speak_thousands(x) { // force speaking thousands
            if(x >= 1000) {
                x = '' + x;
                return x.substring(0, x.length-3) + ',' + x.substring(x.length-3);
            }
            return x;
        }
        
        function speak_half(x) {
            const fx = Math.floor(x);
            if(Math.abs((x - fx) - .5) < .0001) { 
                if(fx == 0) { return 'half'; }
                return fx + ' and a half'; 
            }
            return x;
        }
        
        /* Problem generators, returning <problem> := {
                problem:STR,  // use '?' for the placeholder; '*' for multiplication, '/' for division. See format_problem()
                solution:STR, 
                hint:OBJ,
                [placeholder:true]  // add if the question has a variable/placeholder
            }
            Alternatively, a problem generator can return a <list of problems> := {
                type: 'problem_list',
                problems: [<problem>, ...]
            }
        */
        const PRBL = {
            add_to_five: function() {  // e.g. 2+?=[5]
                const v = RND(0, 5);
                return {problem: v+'+?=5', placeholder: true, solution:(5-v), hint: {
                    speak_prompt: v+' plus what is five?',
                    speak_solution: 'Yes, '+v+' plus '+(5-v)+' is five.',
                    range: [1,5,1,v]
                }};
            },
            add_to_ten: function() {  // e.g. 7+?=[10]
                const v = RND(0, 10);
                return {problem: v+'+?=10', placeholder: true, solution:(10-v), hint:{
                    speak_prompt: v+' plus what is ten?',
                    speak_solution: 'Yes, '+v+' plus '+(10-v)+' is ten.',
                    range:[1,10,1,v]
                }};
            },
            add_small: function() {  // e.g. 3+8=
                const a = RND(0, 10);
                const b = RND(0, 10);
                return {problem: a+'+'+b+'=', solution:(a+b), hint:{
                    speak_solution: 'Yes, '+a+' plus '+b+' is '+(a+b)+'.',
                    range:[1,20,1,a]
                }};
            },
            add_mid: function() {  // e.g. 13+8=
                const a = RND(0, 10) + 10;
                const b = RND(0, 10);
                return {problem: a+'+'+b+'=', solution:(a+b), hint:{range:[11,30,11,a]}};
            },
            add_hundreds: function () {  // e.g. 500+700=
                const a = RND(1, 10) * 100;
                const b = RND(1, 10) * 100;
                return {problem: a+'+'+b+'=', solution:(a+b), hint:{
                    speak_prompt: 'What is '+a+' plus '+b+'?',
                    speak_solution: 'Well done! '+a+' plus '+b+' is '+speak_thousands(a+b)+'.',
                    range:[100,20*100,100,a,100]
                }};
            },
            sub_five: function() {  // e.g. [5]-3=
                const v = RND(0, 5);
                return {problem: '5-'+v+'=', solution:(5-v), hint:{range:[1,5,1,v]}};
            },
            sub_ten: function() {  // e.g. [10]-7=
                const v = RND(0, 10);
                return {problem: '10-'+v+'=', solution:(10-v), hint:{range:[1,10,1,v]}};
            },
            sub_five_minus: function() {  // e.g. [5]-8=
                const v = RND(0, 8);
                return {problem: '5-'+v+'=', solution:(5-v), hint:{range:[-5,5,1,0]}};
            },
            sub_ten_minus: function() {  // e.g. [10]-13=
                const v = RND(0, 13);
                return {problem: '10-'+v+'=', solution:(10-v), hint:{range:[-3,10,1,0]}};
            },
            sub_small: function() {  // e.g. 7-4=  (always positive)
                let a = RND(0, 10);
                let b = RND(0, 10);
                if(a > b) { const tmp = a; a = b; b = tmp; }
                return {problem: b+'-'+a+'=', solution:(b-a), hint:{range:[1,b,-1,-1]}};
            },
            sub_small_any: function() {  // e.g. 4-7=
                let a = RND(0, 10);
                let b = RND(0, 10);
                return {problem: b+'-'+a+'=', solution:(b-a), hint:{range:[-10,10,0,b]}};
            },
            sub_mid: function() {  // e.g. 12-6=
                const a = RND(0, 10);
                const b = RND(0, 10) + 10;
                return {problem: b+'-'+a+'=', solution:(b-a), hint:{range:[1,b,-1,-1]}};
            },
            add_big_no_carry: function() {  // e.g. 36+42= (no carry)
                const a1 = RND(0, 9);
                const a2 = RND(0, 9);
                const b1 = RND(0, 9);
                const b2 = RND(0, 9-a2);
                const a = a1*10+a2;
                const b = b1*10+b2;
                return {problem: a+'+'+b+'=', solution:(a+b), hint:{range:[a1*10+1,a1*10+20,a1*10+1,a]}};
            },
            add_big_carry: function() { // e.g. 36+48= (always carry)
                const a1 = RND(0, 9);
                const a2 = RND(0, 9);
                const b1 = RND(0, 9);
                const b2 = RND(10-a2, 9);
                const a = a1*10+a2;
                const b = b1*10+b2;
                return {problem: a+'+'+b+'=', solution:(a+b), hint:{range:[a1*10+1,a1*10+20,a1*10+1,a]}};
            },
            add_big_small: function() { // e.g. 44+8=
                const a1 = RND(0, 9);
                const a2 = RND(0, 9);
                const b2 = RND(0, 9);
                const a = a1*10+a2;
                const b = b2;
                return {problem: a+'+'+b+'=', solution:(a+b), hint:{range:[a1*10+1,a1*10+20,a1*10+1,a]}};
            },
            small_multiply: function() { // e.g. 3x2=
                const a = RND(1, 5);
                const b = RND(0, 4);
                return {problem: a+'*'+b+'=', solution:(a*b), hint:{
                    speak_prompt: 'What is '+a+' times '+b+'?',
                    speak_solution: 'Yes, '+a+' times '+b+' is '+(a*b),
                    range:[0,b*5,b*10,b*10,b]
                }}; 
            },
            multiply: function() { // e.g. 3x6= (twelve times table) - return groups of 3
                const get_prob = function(a, b) {
                    return {problem: a+'*'+b+'=', solution:(a*b), hint:{
                        speak_prompt: 'What is '+a+' times '+b+'?',
                        speak_solution: 'Yes, '+a+' times '+b+' is '+(a*b),
                        // range:[0,b*12,b*10,b*10,b],
                        /*
                        help_txt:
                            (b>0 ? a+'*'+(b-1)+'='+(a*(b-1))+'#' : '')
                            + a+'*'+b+'=?#'
                            + a+'*'+(b+1)+'='+(a*(b+1))
                        */
                        help_speech:
                        ((a==10 || b==10)?'To multiply by ten, just write a zero after the other number.':
                        ((a==0 || b==0)?'You are multiplying by zero':
                        ((a==1 || b==1)?'You are multiplying by one':
                        (( (a==9 && b<10) || (b==9 && a<10))?'To multiply by nine, take one less than the other number. That is the first digit. For the second digit, take how many you need to nine.':
                        (( (a==11 && b<10) || (b==11 && a<10))?'The two digits will be the same':
                        ((a==12)?('Split the problem. Take ten times '+b+' and add two times '+b+'.'):
                        ((b==12)?('Split the problem. Take ten times '+a+' and add two times '+a+'.'):
                        ((a==11)?('Split the problem. Take ten times '+b+' and add '+b+'.'):
                        ((b==11)?('Split the problem. Take ten times '+a+' and add '+a+'.'):
                        ((a==5 && (b%2==0))?('Remember that '+b+' times five is '+(b/2)+' pairs of fives.'):
                        ((b==5 && (a%2==0))?('Remember that '+a+' times five is '+(a/2)+' pairs of fives.'):
                        ((a==5)?('How much is '+(b-1)+' times five? Then add five.'):
                        ((b==5)?('How much is '+(a-1)+' times five? Then add five.'):
                        (( (a==4 && b==3) || (a==3 && b==4))?'This is the special number that you can split into threes and fours, too.':
                        ((a==4)?('To get '+b+' times four, take '+b+' times two, twice.'):
                        ((b==4)?('To get '+a+' times four, take '+a+' times two, twice.'):
                        ((a==3)?('Take '+b+' times two, and add '+b+'.'):
                        ((b==3)?('Take '+a+' times two, and add '+a+'.'):
                        ((a==6)?('Take how much'+b+' times five is, and add '+b+'.'):
                        ((b==6)?('Take how much'+a+' times five is, and add '+a+'.'):
                        ('Remember that '+a+' times '+(b-1)+' is '+(a*(b-1))+'.')
                        ))))))))))))))))))))
                    }}; 
                };
                const a = RND(2, 12);
                const b = RND(2, 12);
                let problems = [];
                for(let bb=b; bb<=b+4; bb++) {
                    problems.push(get_prob(a, bb>12?bb-11:bb));
                }
                return {type: 'problem_list', problems: problems};
            },
            halving: function() { // e.g. 10/2=
                const a = RND(0, 12);
                return {problem: a+'/2=', solution:(a/2), hint:{
                    speak_prompt: 'What is half of '+a+'?',
                    speak_solution: 'Yes, '+a+' divided by two is '+speak_half(a/2)+'.',
                    range:[1,a,-1,-1]
                }};
            },
            halving_whole_ph: function() {  // e.g. ?x[2]=8
                const a = RND(1, 6)*2;
                return {problem: '?*2='+a, placeholder: true, solution:(a/2), hint:{
                    speak_prompt: 'What taken twice is '+a+'?',
                    speak_solution: 'Yes, '+(a/2)+' times two is '+a,
                    range:[1,a,-1,-1]
                }};
            },
            halving_whole_phi: function() {  // e.g. [2]x?=8
                const a = RND(1, 6)*2;
                return {problem: '2*?='+a, placeholder: true, solution:(a/2), hint:{
                    speak_prompt: 'Two taken how many times is '+a+'?',
                    speak_solution: 'Yes, two times '+(a/2)+' is '+a,
                    range:[1,a,-1,-1]
                }};
            },
            third_whole: function() {  // e.g. 9/[3]=
                const a = RND(1, 4)*3;
                return {problem: a+'/3=', placeholder: false, solution:(a/3), hint:{
                    speak_prompt: 'What is '+a+' divided by three?',
                    speak_solution: 'Good job! The third of '+a+' is '+(a/3),
                    range:[1,a,-1,-1]
                }};
            },
            third_whole_ph: function() {  // e.g. ?x[3]=9
                const a = RND(1, 4)*3;
                return {problem: '?*3='+a, placeholder: true, solution:(a/3), hint:{
                    speak_prompt: 'What taken three times is '+a+'?',
                    speak_solution: 'Good job! '+(a/3)+' times three is '+a,
                    range:[1,a,-1,-1]
                }};
            },
            third_whole_phi: function() {  // e.g. [3]x?=9
                const a = RND(1, 4)*3;
                return {problem: '3*?='+a, placeholder: true, solution:(a/3), hint:{
                    speak_prompt: 'Three taken how many times is '+a+'?',
                    speak_solution: 'Good job! Three times '+(a/3)+' is '+a,
                    range:[1,a,-1,-1]
                }};
            },
            fifth_whole: function() {  // e.g. 9/[5]=
                const a = RND(1, 5)*5;
                return {problem: a+'/5=', placeholder: false, solution:(a/5), hint:{
                    speak_prompt: 'What is '+a+' divided by five?',
                    speak_solution: 'Good job! The fifth of '+a+' is '+(a/5),
                    range:[1,a,-1,-1]
                }};
            },
            fifth_whole_ph: function() {  // e.g. ?x[5]=25
                const a = RND(1, 5)*5;
                return {problem: '?*5='+a, placeholder: true, solution:(a/5), hint:{
                    speak_prompt: 'What taken five times is '+a+'?',
                    speak_solution: 'Great! '+(a/5)+' times five is '+a,
                    range:[1,a,-1,-1]
                }};
            },
            fifth_whole_phi: function() {  // e.g. [5]x?=25
                const a = RND(1, 5)*5;
                return {problem: '5*?='+a, placeholder: true, solution:(a/5), hint:{
                    speak_prompt: 'Five taken how many times is '+a+'?',
                    speak_solution: 'Great! Five times '+(a/5)+' is '+a,
                    range:[1,a,-1,-1]
                }};
            },
        };

        // Lists problems and their relative frequencies
        const PROBLEMSETS = {
            0: [
                [PRBL.add_to_five, 5],
                [PRBL.add_to_ten, 5],
                [PRBL.add_mid, 20],
                [PRBL.sub_five_minus, 10],
                [PRBL.sub_ten_minus, 10],
                [PRBL.sub_small, 20],
                [PRBL.add_hundreds, 10],
                [PRBL.add_big_no_carry, 10],
                [PRBL.small_multiply, 10],
                [PRBL.halving, 10],
                [PRBL.halving_whole_ph, 5],
                [PRBL.halving_whole_phi, 5],
                [PRBL.third_whole_ph, 5],
            ],
            1: [
                [PRBL.add_to_five, 1],
                [PRBL.add_to_ten, 5],
                [PRBL.sub_five_minus, 5],
                [PRBL.sub_ten_minus, 5],
                [PRBL.sub_small_any, 5],
                [PRBL.sub_mid, 20],
                [PRBL.add_hundreds, 15],
                [PRBL.add_big_no_carry, 10],
                [PRBL.add_big_carry, 20],
                [PRBL.add_big_small, 10],
                [PRBL.add_hundreds, 10],
                [PRBL.multiply, 20],
                [PRBL.halving, 8],
                [PRBL.halving_whole_ph, 4],
                [PRBL.halving_whole_phi, 4],
                [PRBL.third_whole, 8],
                [PRBL.third_whole_ph, 4],
                [PRBL.third_whole_phi, 4],
                [PRBL.fifth_whole, 8],
                [PRBL.fifth_whole_ph, 4],
                [PRBL.fifth_whole_phi, 4],
            ],
            2: [
                [PRBL.multiply, 20],
            ]
        };

        // Application data
        const bee = {
            app_name: 'count',
            load_time: Date.now(),
            problemset: false, // index (int)
            problem: false, // output of a problem generator, {problem:HTML, solution:STR, hint:OBJ}
            queued_problems: false,
            can_type: false,
            typed: '',
            can_use_help: true,
            help_timeout: false,
            score_anim_timeout: false,
            player: false,  // name of the player - scores are saved to browser under this name
            $input: $('.prompt .infield .inp'),
            storage: {'players': {}},  // storage data that's saved into local storage
            giftlist: -1,
            score_goal: 30,  // controls the bar under the score and gifts
        };
        
        // Try to load data
        if(localStorage.count) {
            bee.storage = JSON.parse(localStorage.count);
            if(typeof(bee_local) !== 'undefined' && bee_local.loaded_hook) {
                bee_local.loaded_hook('count');
            }
        }

        function save_storage(msg) {
            console.log("Saving storage", msg);
            const s = JSON.stringify(bee.storage);
            localStorage.count = s;
            if(typeof(bee_local) !== 'undefined' && bee_local.save_hook) {
                bee_local.save_hook(s);
            }            
        }

        // Fix emojis
        $('.prompticon').html('üëâ'+"\ufe0f");
        $('.prompticonsuccess').html('‚úÖ'+"\ufe0f");
        $('.keypad [data-i="ent"]').html('üÜó'+"\ufe0f");
        $('.keypad [data-i="help"]').html('‚ùì'+"\ufe0f");
        
        $('.hintloader').hide();

    </script>
    <script src="assets/common.js?111"></script>
    <script>

        
        function clear_hint() {
            $('.hint').html('');
        }

        
        function show_help() {
            // hint syntax: {range: [range-min, range-max, highlight-min, highlight-max]}
            // hint syntax: {range: [range-min, range-max, highlight-min, highlight-max, step]}
            const data = bee.problem.hint;
            if(data === false) {
                playme('notavail');
                return;
            }
            
            bee.can_type = false;
            $('.hintloader').show();
            $('.hint').hide();
            setTimeout(function() {
                let o = '<tr>';
                if(data.range) {
                    let step = 1;
                    if(data.range.length >= 5) { step = data.range[4]; }
                    // const all_steps = (data.range[1] - data.range[0]) / step;
                    if(step > 0) {
                        let ix = 0;
                        for(let i=data.range[0]; i<=data.range[1]; i+=step) {
                            if((ix % 10) == 0 && ix != 0) { o += '</tr><tr>'; }
                            const h = (i >= data.range[2] && i <= data.range[3]); // highlight
                            o += '<td class="'+(h?' hint-h':'')+(i>=200?' wide':'')+'"><div>'+(i<10 && i>=0 ? '&nbsp;' : '')+i+'</div></td>';
                            ix++;
                        }
                    } else {
                        playme('notavail');
                    }
                }
                if(data.help_txt) {
                    o = '<td>'+format_problem(data.help_txt)+'</td>';
                }
                if(data.help_speech) {
                    o = '<td>'+esc_html(data.help_speech)+'</td>';
                }
                o += '</tr>';
                $('.hint').html(o);
                setTimeout(function() {
                    $('.hintloader').hide();
                    $('.hint').show();
                }, 100); // allow rendering
                
                if(data.help_speech) {
                    bee_tts.speak(data.help_speech);
                }
                else if(data.speak_prompt) { 
                    bee_tts.speak(data.speak_prompt); 
                }
                
                bee.can_type = true;
            }, 3000); // hint wait time
        }

        
        function update_input_field() {
            bee.$input.html(esc_html(bee.typed));
        }
        

        function process_keypad(e) {
            e.preventDefault = true;
            if(!bee.can_type) { return; }
            playme('click');
            const $this = $(this);
            let v = $this.data('i');
            
            $this.addClass('pressed');
            setTimeout(function(){ $this.removeClass('pressed'); }, 200);
            
            if(v != '') {
                if(v.substring(0, 1) == 'D') { v = v.substring(1); }
                type_action(v);
            }
        }
        
        
        function type_action(c) {
            if(c == 'help') { 
                show_help();
                return false;
            }
            
            if(c == 'del') {
                if(bee.typed.length > 0) {
                    bee.typed = bee.typed.substring(0, bee.typed.length-1);
                    update_input_field();
                }
                return false;
            }
            
            if(c == 'ent') {
                // Convert half at end
                let value = bee.typed;
                if(value.length == 0) { return; }
                if(value.substring(value.length-1) == HALF) {
                    value = value.substring(0, value.length-1) + '.5';
                }
                console.log("Value", value, "Target", bee.problem.solution);
                
                if((value - 0) == bee.problem.solution) { // Success!
                    bee.can_type = false;
                    store_question(bee.queued_problems); // This is shorter now as we used shift()
                    $('.prompt').addClass('success');
                    if(!(bee.problem.hint 
                        && bee.problem.hint.speak_solution
                        && bee_tts.speak(bee.problem.hint.speak_solution, function() {
                            success_common(true); // true = move fast to next question
                        })
                    )) {
                        success_common();
                    }
                }
                return false;
            }
            
            if(c == 'half') {
                if(bee.typed.length < MAX_INPUT) {
                    bee.typed += HALF;
                    update_input_field();
                }
                return false;
            }
            
            if(String(c).search(/^[\-0-9]$/) !== -1) {
                if(bee.typed.length < MAX_INPUT) {
                    bee.typed += c;
                    update_input_field();
                }
                return false;
            }
            
        }
        
                
        function process_keypress(event) {
            event.preventDefault = true;
            if(!bee.can_type) { return; }
            if((event.keyCode >= 48 && event.keyCode <= 57) || event.key == '-') { // 0-9 and -
                type_action(event.key);
                return;
            }
            if(event.keyCode == 8) { type_action('del'); return; }
            if(event.keyCode == 13) { type_action('ent'); return; }
            if(event.keyCode == 112 || event.keyCode == 113 || event.keyCode == 27 || event.keyCode == 192) { // F1, F2, ESC, pipe
                type_action('help');
                return;
            }
            // console.log("key", event);
        }
        
        
        // Format the problem string
        function format_problem(p) {
            const PL = '<span class="ph">a</span>'; // placeholder
            const DIV = '√∑';
            const MULT = 'x';
            p = p.replaceAll('&', '`a&amp;`b');
            p = p.replaceAll('>', '`c&gt;`d');
            p = p.replaceAll('<', '`c&lt;`d');
            
            p = p.replace(/^([0-9]+)\*([0-9]+)/, function(match,p1,p2) {
                // #fffae4
                let numcols = {
                    '2':'`hf2c79f',
                    '3':'`hefea8f',
                    '4':'`h98ee8f',
                    '5':'`h9b8fee',
                    '6':'`hd38fee',
                    '7':'`hee8f8f',
                    '8':'`hee8fc1',
                    '9':'`h939293',
                    '10':'`hfdfdfd',
                    '11':'`hffdbdb',
                    '12':'`hfbac1b',
                };
                let c1 = numcols[p1] || '#fffae4';
                let c2 = numcols[p2] || '#fffae4';
                return '<span style`e"padding:0 .3rem;background: linear`ggradient(90deg,'+c1+' 0%, `hfffae4 50%, '+c2+' 100%);">'+match+'`f';
            });
            
            p = p.replaceAll('?', '`p');
            p = p.replaceAll('/', '`a'+DIV+'`b');
            p = p.replaceAll('*', '`a'+MULT+'`b');
            p = p.replaceAll('+', '`a+`b');
            p = p.replaceAll('-', '`a-`b');
            p = p.replaceAll('=', '`c=`d');
            p = p.replaceAll('#', '<br>');
            // placeholder
            p = p.replaceAll('`p', PL);
            // operators
            p = p.replaceAll('`a', '<span class="op">');
            p = p.replaceAll('`b', '</span>');
            // comparison operators
            p = p.replaceAll('`c', '<span class="cmpop">');
            p = p.replaceAll('`d', '</span>');
            // mult gradient
            p = p.replaceAll('`e', '=');
            p = p.replaceAll('`f', '</span>');
            p = p.replaceAll('`g', '-');
            p = p.replaceAll('`h', '#');
            return p;
        }

        
        // Initialize a question
        function start_question() {
            bee.can_type = true;
            
            $('.problem').html(format_problem(bee.problem.problem));
            if(bee.problem.hint && bee.problem.hint.speak_prompt) { bee_tts.speak(bee.problem.hint.speak_prompt); }
            
            // Add help & input
            bee.typed = '';
            update_input_field();
            $('.prompt').removeClass('success');
            $('.prompt-ph').toggle(bee.problem.placeholder ? true : false);
            clear_hint();
        }

        
        // Prevent getting a new question when the page is refreshed (a cheat to get out of difficult questions)
        function store_question(problem_data) {
            bee.storage.players[bee.player].current_question = problem_data;
            save_storage('store_question');
        }

        function get_question_from_store() {
            const w = bee.storage.players[bee.player].current_question;
            return w;
        }
        
        // Another cheat: switching to the calculator app
        var wentaway = 0; // counts the switches away
        var wentaway_penalty = false;
        document.addEventListener('visibilitychange', function(){
            if(wentaway_penalty) { return; }
            if(document.hidden) { wentaway++; return; }
            if(wentaway) {
                bee.can_type = false;
                wentaway_penalty = true;
                $('.hintloader').show();
                $('.problem').hide();
                setTimeout(function() {
                    $('.hintloader').hide();
                    $('.problem').show();
                    bee.can_type = true;
                    wentaway_penalty = false;
                }, 12*1000);
            }
        });

        
        function new_question() {
            // Refresh the page periodically
            if(Date.now() - bee.load_time > 12*60*60*1000) {
                window.location.reload(true);
                return;
            }

            try{ document.activeElement.blur(); }catch(e){}

            // First see if we stored any question in store
            // Prevent getting a new question when the page is refreshed (a cheat to get out of difficult questions)
            if(!(bee.queued_problems && bee.queued_problems.length)) {
                bee.queued_problems = get_question_from_store();
            }

            if(!(bee.queued_problems && bee.queued_problems.length)) {
                // Choose a problem generator
                const pset = PROBLEMSETS[bee.problemset];
                let freq_sum = 0;
                for(let i=0; i<pset.length; i++) { freq_sum += pset[i][1]; }
                const freq = Math.random() * freq_sum;
                freq_sum = 0;
                let i=0;
                for(i=0; i<pset.length; i++) {
                    freq_sum += pset[i][1];
                    if(freq <= freq_sum) { break; }
                }
                
                // Get a problem
                const new_prob = pset[i][0]();
                if(new_prob.type == 'problem_list') {
                    bee.queued_problems = new_prob.problems;
                }
                else {                
                    bee.queued_problems = [new_prob];
                }
                store_question(bee.queued_problems);
            }
            
            bee.problem = bee.queued_problems.shift();
            start_question();
        }
        
        
        // Choose a range of word sets to show words from
        function choose_problemset() {
            let p = prompt("What set of problems should we use?\nType a number from 0 to "+max_problemset+" (simple to difficult)") - 0;
            if(isNaN(p)) { p = 0; }
            return p;
        }
        
        
        function init_problemset() {
            let p = bee.storage.players[bee.player].problemset;
            if(p === undefined) { p = 0; }
            $('.d_wordsets').html(esc_html(p));
            bee.problemset = p;
        }
        
        
        function modify_problemset() {
            if(bee.player === false) { alert("Choose a player first"); return; }
            const p = choose_problemset();
            bee.storage.players[bee.player].problemset = p;
            save_storage();
            init_problemset();
            new_question();
        }
        
        
        function main() {
            document.addEventListener('keydown', process_keypress); // Or use 'keypress' event
            $('.keypad td').on('click', process_keypad);

            update_score_ui(false);
            $('.d_player').html(esc_html(bee.player));
            init_problemset();
            new_question();
        }
        
        
        // Start menu - render
        // Audio can only be played after a user event on the page, so we require a click
        menu = "<p>Choose player</p>";
        for (const [key, value] of Object.entries(bee.storage.players)) {
            menu += '<div class="startbutton" data-player="'+esc_html(key)+'">'+esc_html(key)+'</div>';
        }
        menu += '<div class="startbutton" data-playernew="1">New user<br><span style="font-size:60%">All player data is stored in the browser only</span></div>';
        $('.game').hide();
        $('.startmenu').html(menu);
        
        // Start menu - logic
        setTimeout(function() {  // allow time for rendering
            $('.startbutton').on('click', function() {
                
                if($(this).data('playernew')) {
                    bee.player = prompt("What is the name of the player?");
                    if(bee.player === null || bee.player === '') { return false; }

                    // Initialize
                    if(!bee.storage.players[bee.player]) {
                        const p = choose_problemset();
                        bee.storage.players[bee.player] = {'score': 0, 'problemset': p};
                        save_storage();
                    } else {
                        alert("That player already exists. Loading player data");
                    }
                } else {
                    bee.player = $(this).data('player');
                }
                
                $('.startmenu').hide();
                $('.game').show();
                main();
                return false;
            });
        }, 200);
        
        
    </script>

</body>
</html>

