<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta http-equiv="Content-Language" content="en">
    <meta name="viewport" content="initial-scale=1.0">
    <title>SpellBee</title>
    <link rel="stylesheet" type="text/css" href="assets/common.css?86">

    <style>
    
        .prompt .img {
            font-family: Apple Color Emoji,Segoe UI Emoji,Noto Color Emoji,Android Emoji,EmojiSymbols,EmojiOne Mozilla,Twemoji Mozilla,Segoe UI Symbol,Noto Color Emoji,EmojiOne Color,emoji;
            display: inline-block;
            font-size: 8rem;
            text-align: center;
            background: #fff;
            border-radius: 1rem;
            height: 12rem;
            line-height: 12rem;
            width: 12rem;
        }
        
        .prompt .infield {
            display: block;
            line-height: 6rem;
            border-radius: 1rem;
            background: #fffae4;
            font-size: 5rem;
            margin: 1rem 0;
            padding: 0 1rem;
            min-width: 35rem;
            letter-spacing: .3rem;
        }
        
        .prompt .infield .help,
        .prompt .infield .inp {
            display: inline-block;
        }

        .prompt .infield .help { color: #05b; }
        .prompt .infield .inp { color: #000; }
        .prompt .infield .inp .spacehelp { color: #ccc; }
        body .prompt .infield .success { color: #090; }
        .prompt .infield .helpwait { display: none; }

        @keyframes blink-animation { to { visibility: hidden; } }
        
        .cursor {
            animation: blink-animation 2s steps(2, start) infinite;
            display: inline-block;
            border: 2px solid #f77;
            width: .2rem;
            height: 4rem;
            margin-left: -1px;
            border-right: 0 solid transparent;
        }
        
        .infield .help .cursor { visibility: hidden; }
        
        .wrongchar { text-decoration: underline dotted #05b .3rem; }
        
        .keyhelp {
            margin-top: 4rem;
            font-size: 1.5rem;
            opacity: .7;
        }

    </style>

    <script src="assets/fireworks/fireworks.js"></script>
    <script src="assets/confetti/js-confetti.browser.js"></script>
    <script src="assets/jquery/jquery-3.7.1.min.js"></script>
    <script src="assets/local/beelocal.js?86"></script>
</head>
<body>
    <div class="container">

        <div class="game scorewrap">
            <div class="score">
                <span class="icon">ü™ô</span> <span class="value">0</span>
                <div class="bar"><span class="barfill"></span></div>
            </div><div class="gifts"><span class="open">üéÅ</span><span class="close">X</span><span class="needed">-</span></div>
        </div>
        <div class="game prompt">
            <span class="img"></span>
            <span class="infield"><span class="help"></span><img class="helpwait" src="assets/images/loader.gif"><span class="inp"></span></span>
        </div>
        
        <div class="game keyhelp">1Ô∏è‚É£=‚ùì &nbsp; 2Ô∏è‚É£=üí¨</div>
        
        <div class="startmenu"></div>

        <div class="giftlist">
            <span class="title">Gifts collected</span>
            <div class="list">
                <img src="assets/images/nogift.png">
                <span class="next">Next</span>
                <span class="exchange">Exchange<br>ü™ôü™ô</span>
            </div>
        </div>
        
        <div class="giftannounce">
            <span></span>
            <img src="assets/images/nogift.png">
        </div>

    </div>
    <p class="smallprint">
    v<span class="d_version"></span>
    Player: <span class="d_player"></span>
    | Word sets: <span class="d_wordsets"></span>
    </p>
    <p class="smallprint">Hint: Press 1, F1, F2, ESC or the button under ESC (some may trigger other functions)</p>
    
    <p class="smallprint">Use this page with a physical keyboard | <span class="handle">Licences</span>
    <span class="expand"></span> 
    | Icons by <a href="https://icons8.com">Icons8</a>
    | <a href="https://github.com/csirmaz/learning-aid">Codebase</a>
    | <a href="#" onclick="bee_tts.speak('This is what text to speach sounds like: '+Math.floor(Math.random()*100), function(){ alert(bee_tts.voice.name+' '+bee_tts.voice.lang+' '+bee_tts.voice.localService); }); return false">TTS</a>
    | <a href="#" onclick="window.location.reload(true); return false">Switch player</a>
    | <a href="#" onclick="modify_wordlist(); return false">Update word sets</a>
    | <a href="#" onclick="reduce_score(); return false">Reduce score</a>
    </p>

    <div class="fireworks-container"></div>
    
    <script>
    
        // Words, split into sets
        // Format: ['{emoji}', '{word to spell}'], or
        //         ['{emoji}', '{phrase with > before every character to type}']   (e.g. ['*', 'Look! A >s>t>a>r!'])
        // Use e.g. https://getemoji.com/

        // The page will attempt to play assets/sounds/words/<word to spell>.mp3 (lowercased and spaces replaced by underscores)
        // Use e.g. https://ttsmp3.com/ to generate them
        
        // [WORDS START]
        const word_sets = [
            [ // Word set 0
                ['üì¶', 'box'],
                ['üêà‚Äç', 'cat'],
                ['üç±', 'food'],
                ['üî•', 'hot'],
                ['üñäÔ∏è', 'pen'],      
                ['üü•', 'red'],
                ['üåπ', '>r>e>d rose'],
                ['üèä', 'swim'],
                ['üå≥', 'tree'],
            ],
            [ // Word set 1
                ['üõå', 'bed'],
                ['üêÑ', 'cow'],
                ['ü•Å', 'drum'],
                ['üèãÔ∏è', 'gym'],
                //['üè®', 'hotel'],
                ['üè®', 'Sleep in a >h>o>t>e>l'],
                ['ü•ù', 'kiwi'],
                ['ü™∫', 'nest'],
                ['üçù', 'pasta'],
                ['üìå', 'pin'],
                ['üíç', 'ring'],
                ['ü¶à', 'shark'],
                ['üêç', 'snake'],
                // ['üéæ', 'tennis'],
                ['üéæ', 'play >t>e>n>n>i>s'],
                ['‚õ∫Ô∏è', 'tent'],
            ],
            [ // Word set 2
                ['ü•ö', 'egg'],      
                ['üëú', 'bag'],
                ['üèÉüèª‚Äç‚ôÇÔ∏è‚Äç‚û°Ô∏è', 'run'],
                ['üêñ', 'pig'],
                //['ü•õ', 'milk'],
                ['ü•õ', 'I drink >m>i>l>k'],
                ['üñêÔ∏è', 'hand'],
                //['üòÅ', 'grin'],
                ['üòÅ', 'happy >g>r>i>n'],
                ['üê†', 'fish'],
                ['üåú', 'moon'],
                ['üö™', 'door'],
                ['ü•Ñ', 'spoon'],
                ['üôÖüèº‚Äç‚ôÄÔ∏è', 'not'],
                ['ü™Ü', 'toy'],
                ['üßë', 'boy'],
                ['üëçüèø', 'thumb'],
            ],
            [ // Word set 3
                ['üñç', 'crayon'],
                ['üëÅ', 'eye'],
                ['‚ñ∂Ô∏è', 'play'],
                ['üõ°', 'shield'],
                // ['üåû', 'sun'],
                ['üåû', 'The >s>u>n shines.'],
                ['‚ùÑÔ∏è', 'snow'],
                ['ü™®', 'rock'],
                ['üîí', 'lock'],
                // ['üîî', 'bell'],
                ['üîî', 'ring the >b>e>l>l'],
                ['üîî', '>r>i>n>g the bell'],
                ['üêë', 'sheep'],
                ['üçã', 'lemon'],
                //['‚õ≥Ô∏è', 'golf'],
                ['‚õ≥Ô∏è', '>p>l>a>y golf'],
                ['‚õ≥Ô∏è', 'play >g>o>l>f'],
                ['üè¶', 'bank'],
                // ['üí≥', 'card'],
                ['üí≥', 'pay with >c>a>r>d'],
                ['üß∏', 'teddy'],
                ['ü™Ω', 'wing'],
                // ['üòÄ', 'happy'],
                ['üòÄ', 'I am >h>a>p>p>y'],
            ],
            [ // Word set 4
                ['üëÉüèª', 'nose'],
                ['üëÇ', 'ear'],
                ['üëû', 'shoe'],
                ['üß•', 'coat'],
                ['üåà', 'rainbow'],
                //['üßä', 'ice'],
                ['üßä', 'cold >i>c>e'],
                ['üßä', '>c>o>l>d ice'],
                ['üçø', 'popcorn'],
                ['üöú', 'tractor'],
                ['üß∫', 'basket'],
                ['üîë', 'key'],
                ['üìè', 'ruler'],
                ['‚ù§Ô∏è', 'heart'],
                //['üß£', 'scarf'],
                ['üß£', 'warm >s>c>a>r>f'],
                //['ü´Ç', 'love'],
                ['ü´Ç', 'I >l>o>v>e you'],
                ['ü´Ç', 'I love >y>o>u'],
                ['‚õÑÔ∏è', 'snowman'],
                // ['üçï', 'pizza'],
                ['üçï', 'I love >p>i>z>z>a'],
                ['üçï', '>I> >l>o>v>e pizza'],
                //['üéπ', 'piano'],
                ['üéπ', 'play the >p>i>a>n>o'],
                ['üß±', 'wall'],
                ['üçÑ', 'mushroom'],
                ['üê§', 'chick'],
                //['üç¨', 'candy'],
                ['üç¨', 'sweet >c>a>n>d>y'],
                // ['üåπ', 'rose'],
                ['üåπ', 'red >r>o>s>e'],
                ['üêá', 'rabbit'],
                ['üöÇ', 'train'],
                ['üé∫', 'trumpet'],
                ['ü¶ä', 'fox'],
                ['üê¥', 'horse'],
                ['üê∂', 'dog'],
                ['ü¶Ü', 'duck'],
                //['üåΩ', 'corn'],
                ['üåΩ', 'I like >c>o>r>n'],
                ['üåΩ', 'I >l>i>k>e corn'],
                //['üê≠', 'mouse'],
                ['üê≠', 'The >m>o>u>s>e likes cheese'],
                ['üê≠', 'The mouse >l>i>k>e>s cheese'],
                ['üêµ', 'monkey'],
                ['üíß', 'water'],
                ['üöó', 'car'],
                ['‚¨úÔ∏è', 'white'],
                ['‚¨õÔ∏è', 'black'],
                ['üü©', 'green'],
                ['üè´', 'school'],
                //['üåÉ', 'night'],
                ['üåÉ', 'Good >n>i>g>h>t!'],
                ['üèûÔ∏è', 'river'],
                //['üåÖ', 'morning'],
                ['üåÖ', 'early >m>o>r>n>i>n>g'],
                ['üè°', 'home'],
                ['ü•∂', 'cold'],
                //['üåã', 'lava'],
                ['üåã', '>l>a>v>a is hot'],
                ['ü™∞', 'fly'],
                ['üõë', 'stop'],
            ],
            [ // Word set 5
                ['üñº', 'picture'],
                ['üëÑ', 'mouth'],
                ['ü¶¥', 'bone'],
                ['ü¶ú', 'parrot'],
                // ['‚òîÔ∏è', 'rain'],
                ['‚òîÔ∏è', '>r>a>i>n falls'],
                ['üç™', 'cookie'],
                ['üçå', 'banana'],
                ['üò¢', 'cry'],
                ['üë∂', 'baby'],
                //['üëë', 'crown'],
                ['üëë', 'The king\'s >c>r>o>w>n'],
                ['üß¶', 'socks'],
                //['ü¶∂', 'foot'],
                ['ü¶∂', 'smelly >f>o>o>t'],
                //['üî•', 'fire'],
                ['üî•', '>F>i>r>e is hot'],
                ['‚úàÔ∏è', 'plane'],
                ['üè†', 'house'],
                //['üì±', 'phone'],
                ['üì±', 'Call the >p>h>o>n>e'],
                ['ü™ß', 'sign'],
                ['ü§ñ', 'robot'],
                ['üèúÔ∏è', 'desert'],
                // ['üë©‚Äçü¶∞', 'woman'],
                ['üë©‚Äçü¶∞', 'one >w>o>m>a>n'],
                //['üë≠', 'women'],
                ['üë≠', 'two >w>o>m>e>n'],
                //['ü•©', 'meat'],
                ['ü•©', 'Eat >m>e>a>t'],
                ['üì®', 'mail'],
                ['üë®‚Äçü¶±', 'male'],
                ['ü¶∂üèΩ', 'heel'],
                ['üë®üèæ‚Äç‚öïÔ∏è', 'heal'],
                ['ü™¢', 'knot'],
                ['üõ£', 'road'],
                //['‚õè', 'break'],
                ['‚õè', 'It can >b>r>e>a>k stone'],
                ['‚õè', 'It can break >s>t>o>n>e'],
                //['ü¶ªüèΩ', 'hear'],
                ['ü¶ªüèΩ', 'I >h>e>a>r you'],
                ['ü¶ªüèΩ', 'I hear >y>o>u'],
                //['üéÉ', 'scary'],
                //['üéÉ', 'pumpkin'],
                ['üéÉ', '>s>c>a>r>y pumpkin'],
                ['üéÉ', 'scary >p>u>m>p>k>i>n'],
                //['üì¶', 'thing'],
                ['üì¶', 'It\'s a >t>h>i>n>g'],
                ['üî©', 'screw'],
                //['üì∞', 'news'],
                ['üì∞', 'good >n>e>w>s'],
                //['üåç', 'world'],
                ['üåç', 'the whole >w>o>r>l>d'],
            ],
            [ // Word set 6
                ['ü™û', 'mirror'],
                ['‚òÅÔ∏è', 'cloud'],
                //['üßó', 'climb'],
                ['üßó', '>c>l>i>m>b up'],
                ['üõù', 'slide'],
                ['üßë‚Äçüè´', 'teacher'],
                ['üëï', 'shirt'],
                ['üè•', 'hospital'],
                ['üçâ', 'watermelon'],
                ['üï∑', 'spider'],
                ['‚öôÔ∏è', 'steel'],
                // ['üó∫Ô∏è', 'here'],
                ['üó∫Ô∏è', 'We are >h>e>r>e.'],
                ['ü¶ò', 'kangaroo'],
                ['üë©‚Äç‚úàÔ∏è', 'pilot'],
                ['üåä', 'wave'],
                ['üè≠', 'factory'],
                ['ü™•', 'toothbrush'],
                ['üè∑', 'nametag'],

                ['‚òîÔ∏è', 'It is >r>a>i>n>i>n>g.'],
                ['‚òîÔ∏è', 'It is >r>a>i>ning.'],
                ['‚òîÔ∏è', '>I>t> >i>s raining.'],
                ['üòΩ', 'Cat >g>i>v>e>s kiss.'],
                ['üòΩ', 'Cat gives >k>i>s>s.'],
                ['üòæ', 'This cat >i>s> >a>n>g>r>y.'],
                ['üö∂‚Äç‚ôÄÔ∏è‚Äç‚û°Ô∏è', 'She is >w>a>l>k>i>n>g.'],
                ['üö∂‚Äç‚ôÄÔ∏è‚Äç‚û°Ô∏è', '>S>h>e> >i>s walking.'],
                ['üèÉ‚Äç‚ôÇÔ∏è‚Äç‚û°Ô∏è', 'He is >r>u>n>n>i>n>g.'],
                ['üë®üèª‚Äçüçº', 'feeding the baby'],
                // ['üõÄüèæ', 'having a bath'],
                ['üõÄüèæ', 'I am >h>a>v>i>n>g a bath.'],
                ['üõÄüèæ', 'I am having a >b>a>t>h.'],
                ['üçü', 'I want >c>h>i>p>s!'],
                ['üçü', '>I> >w>a>n>t chips!'],
                ['üöª', '>W>h>e>r>e is the toilet?'],
                ['üöª', 'Where >i>s> >t>h>e toilet?'],
                ['üöª', 'Where is the >t>o>i>l>e>t?'],
                ['üèñ', 'We are going on a >h>o>l>i>d>a>y!'],
                ['üèñ', '>W>e> >a>r>e going on a holiday!'],
                ['üèñ', 'We are >g>o>i>n>g on a holiday!'],
                ['üó∫', '>W>h>e>r>e are we?'],
                ['üó∫', 'Where >a>r>e> >w>e?'],
                ['ü§´', 'Keep it a >s>e>c>r>e>t!'],
                ['ü§´', '>K>e>e>p it a secret!'],

                //['ü™ú', 'ladder'],
                ['ü™ú', 'climb up the >l>a>d>d>e>r'],
                ['ü™ú', '>c>l>i>m>b> >u>p the ladder'],
                // ['üõû', 'wheel'],
                ['üõû', 'The >w>h>e>e>l turns.'],
                ['üìé', '>p>a>p>e>r clip'],
                ['üìé', 'paper >c>l>i>p'],
                ['üöì', '>p>o>l>i>c>e car'],
                ['üöì', 'police >c>a>r'],
                // ['üë¶', 'brother'],
                ['üë¶', 'my >b>r>o>t>h>e>r'],
                ['üë¶', '>m>y brother'],
            ],
            [ // Word set 7
                //['ü™ô', 'coin'],
                ['ü™ô', '>g>o>l>d coin'],
                ['ü™ô', 'gold >c>o>i>n'],
                // ['ü™∂', 'feather'],
                ['ü™∂', '>l>i>g>h>t as a feather'],
                ['ü™∂', 'light as a >f>e>a>t>h>e>r'],
                ['ü™∂', 'light >a>s> >a feather'],
                //['üì¶', 'package'],
                ['üì¶', 'A >p>a>c>k>a>g>e arrived.'],
                ['üì¶', 'A package >a>r>r>i>v>e>d.'],
                //['ü¶í', 'giraffe'],
                ['ü¶í', 'The >g>i>r>a>f>f>e is tall.'],
                ['ü¶í', 'The giraffe is >t>a>l>l.'],
                ['üöÅ', 'helicopter'],
                // ['üõ¨', 'arrive'],
                ['üßö‚Äç‚ôÇÔ∏è', 'appear'],
                //['üëØ‚Äç‚ôÄÔ∏è', 'group'],
                ['üëØ‚Äç‚ôÄÔ∏è', 'a >g>r>o>u>p of people'],
                // ['üé∂', 'hymn'],
                ['üé∂', 'We sing a >h>y>m>n.'],
                ['üá™üá¨', 'Egypt'],
                ['üî£', 'symbol'],
                ['üïµÔ∏è', 'mystery'],
                ['üèúÔ∏è', 'pyramid'],
                // ['üê¨', 'dolphin'],
                ['üê¨', 'The >d>o>l>p>h>i>n likes fish.'],
                ['üê¨', 'The dolphin >l>i>k>e>s> >f>i>s>h.'],
                ['üíé', 'diamond'],
                ['üé§', 'lyric'],
                ['üëª', 'myth'],
                ['ü§î', 'forgetting'],
                ['‚òëÔ∏è', 'preferred'],
                //['‚õîÔ∏è', 'forbidden'],
                ['‚õîÔ∏è', 'Smoking is >f>o>r>b>i>d>d>e>n'],
                ['üòØ', 'beginner'],
                // ['üòé', 'expert'],
                ['üòé', 'He is an >e>x>p>e>r>t.'],
                ['üè§', 'post office'],
                ['üìâ', 'going down'],
                ['üõ£', 'motorway'],
                //['üóìÔ∏è', 'year'],
                ['üóìÔ∏è', 'A >y>e>a>r later'],

                ['ü™§', 'Careful! It is a >t>r>a>p!'],
                ['ü™§', '>C>a>r>e>f>u>l! It is a trap!'],
                ['üíáüèæ‚Äç‚ôÇÔ∏è', 'Adam needs a >h>a>i>r>c>u>t.'],
                ['üíáüèæ‚Äç‚ôÇÔ∏è', 'Adam >n>e>e>d>s a haircut.'],
                ['üéÇ', 'It is my >b>i>r>t>h>d>a>y!'],
                ['üéÇ', '>I>t> >i>s> >m>y birthday!'],
            ],
        ];
        // [WORDS END]
        
        let words = [];

        // Application data
        const bee = {
            load_time: Date.now(),
            word_ix: false,
            can_type: false,
            typed: '',
            processed_word: false,
            can_use_help: true,
            help_timeout: false,
            score_anim_timeout: false,
            player: false,  // name of the player - scores are saved to browser under this name
            help_asked: 0,  // how many times help was asked for for the current word
            $image: $('.prompt .img'),
            $input: $('.prompt .infield .inp'),
            $help: $('.prompt .infield .help'),
            $helpwait: $('.prompt .infield .helpwait'),
            storage: {'players': {}},  // storage data that's saved into local storage
            giftlist: -1,
            word_audio: false,
            word_audio_timeout: false,
            score_goal: 20,  // controls the bar under the score and gifts
        };

        // Try to load data
        if(localStorage.spellbee) {
            bee.storage = JSON.parse(localStorage.spellbee);
            if(typeof(bee_local) !== 'undefined' && bee_local.loaded_hook) {
                bee_local.loaded_hook('spellbee');
            }
        }

        function save_storage(msg) {
            console.log("Saving storage", msg);
            localStorage.spellbee = JSON.stringify(bee.storage);
        }


    </script>
    <script src="assets/common.js?86"></script>
    <script>
    
        /* EXPLANATION OF TYPED, TO_TYPE, etc.
        
            word = ['o', 'pear']
            bee.processed_word = {to_type: 'pear', to_display: 'pear', mask: false}
        
            word = ['o', 'I eat >a>p>p>l>e.']
            bee.processed_word = {to_type: 'apple', to_display: 'I eat apple.', mask: '******_____*'}
            
            bee.typed = 'ap'
            Display: "I eat ap___."
        */

        // Extract the to_type string from a word entry
        function get_processed_word(word_ix) {
            if(words[word_ix][1].indexOf('>') == -1) { 
                return {'to_type': words[word_ix][1], 'to_display': words[word_ix][1], 'mask': false}; 
            }
            let to_type_str = '';
            let to_disp_str = '';
            let mask_str = '';
            const full = words[word_ix][1];
            let ttype = false;
            for(let i=0; i<full.length; i++) {
                if(full[i] == '>') { ttype = true; continue; }
                if(ttype) { 
                    to_type_str += full[i]; 
                    to_disp_str += full[i];
                    mask_str += '_';
                    ttype = false; 
                    continue; 
                } else {
                    to_disp_str += full[i];
                    mask_str += '*';
                }
            }
            return {'to_type': to_type_str, 'to_display': to_disp_str, 'mask': mask_str};
        }

        
        // Render a typed input into HTML. prefix=what is typed, s=full string
        function render_to_html(for_help) {
            const line_length = 17; // word wrap after this many characters
    
            const s = bee.processed_word.to_display;
            
            // The aim is to leave the underscores in place, so we word
            // wrap according to the target string
            const wrap_at = {};
            let cur_line = 0;
            for(let i=0; i<s.length; i++) {
                cur_line++;
                if(cur_line >= line_length) {
                    wrap_at[i] = 'forced';
                    cur_line = 0;
                    continue;
                }
                if(s[i] == ' ') {
                    let is_full = true;
                    for(let j=1; j<=line_length-cur_line; j++) { // lookahead
                        // console.log("ij", i, j, cur_line);
                        if(i+j >= s.length || s[i+j] == ' ') { 
                            is_full = false; 
                            break; 
                        }
                    }
                    if(is_full) {
                        wrap_at[i] = 'at space';
                        cur_line = 0;
                    }
                }
            }
            // console.log(wrap_at);
            
            let o = '';
            let typed_ix = 0;
            for(let i=0; i<s.length; i++) {
                const totype = (bee.processed_word.mask === false || bee.processed_word.mask[i] == '_'); // whether the character is to be typed
                
                if(for_help) { // We are rendering the help string
                
                    // possibly we can use totype to highlight what needs to be typed
                    o += (s[i] == ' ' ? '&nbsp;' : esc_html(s[i]));
                    if(wrap_at[i]) { o += '<br>'; }
                    
                } else { // We are rendering what the user entered, plus surrounding phrase
                
                    if(totype) { // We are in the area that should be typed
                        if(typed_ix < bee.typed.length) { // The user typed this much
                            const userchar = bee.typed[typed_ix];
                            const wrongchar = (s[i].toLowerCase() != userchar.toLowerCase());
                            if(wrongchar) { o += '<span class="wrongchar">'; }
                            o += (userchar == ' ' ? '&nbsp;' : esc_html(userchar));
                            if(wrongchar) { o += '</span>'; }
                            if(wrap_at[i]) { o += '<br>'; }
                            if(typed_ix == bee.typed.length - 1) { o += '<span class="cursor"></span>'; } // add cursor after last char typed
                        } else { // The user is still to type this
                            if(typed_ix == 0) { o += '<span class="cursor"></span>'; } // add cursor at beginning if no char typed
                            o += (s[i] == ' ' ? '<span class="spacehelp">_</span>' : '_');
                            if(wrap_at[i]) { o += '<br>'; }
                        }
                        typed_ix++;
                    } else { // This does not need to be typed
                        o += (s[i] == ' ' ? '&nbsp;' : esc_html(s[i]));
                        if(wrap_at[i]) { o += '<br>'; }
                    }
                
                }
            }
            return o;
        }
        
        
        // Render the typing and underscores
        function update_input_field() {
            bee.$input.html(render_to_html(false));
        }


        // Display target word briefly
        function show_help(is_initial) {
            console.log("Disabling help");
            bee.can_use_help = false;
            if(bee.help_timeout !== false) { clearTimeout(bee.help_timeout); }

            bee.can_type = false;
            bee.$input.hide();
            
            if(!is_initial) { 
                bee.$helpwait.show(); // show a loading animation
                bee.help_asked++;
            }
            
            const help_duration_loading = 1800; // duration of the loading animation
            const help_duration_1 = 800 + bee.processed_word.to_display.length * 200; // full color
            const help_duration_2 = 1500; // fading
            const help_duration_enable = 4000; // time to enable help again

            setTimeout(function() {
                bee.$helpwait.hide();
                bee.$help.show();
                play_word(bee.processed_word.to_display);
                setTimeout(function() {
                    bee.$help.fadeOut({duration: help_duration_2, complete: function() {
                        bee.$input.show();
                        bee.can_type = true;
                        console.log("Scheduling enabling help");
                        bee.help_timeout = setTimeout(function(){ 
                            console.log("Enabling help");
                            bee.can_use_help = true;
                            bee.help_timeout = false;
                        }, help_duration_enable);
                    }});
                }, help_duration_1); // initial wait while showing the word
            }, is_initial ? 0 : help_duration_loading);
        }
        
                
        // Mark a word as known, and count how many times it was successfully entered
        // A word is known if it could be typed without help
        function add_known_word(word) {
            if(!bee.storage.players[bee.player].known_words) {
                bee.storage.players[bee.player].known_words = {};
            }
            if(bee.storage.players[bee.player].known_words[word] === undefined) {
                bee.storage.players[bee.player].known_words[word] = 1;
            } else {
                bee.storage.players[bee.player].known_words[word]++;
            }
            save_storage('add_known_word');
        }
        
        
        // Return the count of successful entries of a word
        function is_known_word(word) {
            if(bee.storage.players[bee.player].known_words) {
                const c = bee.storage.players[bee.player].known_words[word];
                if(c === undefined) { 
                    console.log("Known words/read:", word, "unknown word");
                    return 0;
                }
                console.log("Known words/read:", word, "returning", c);
                return c;
            }
            console.log("Known words/read:", word, "no storage");
            return 0;
        }
        

        // Play the mp3 assigned to a word
        function play_word(s) {
            if(bee.word_audio_timeout !== false) {
                // prevent playing word too frequently
                return;
            }
            bee.word_audio_timeout = setTimeout(function() { bee.word_audio_timeout = false; }, 3000);
            
            s = s.toLowerCase().replaceAll(/ /g, '_').replaceAll(/[^a-z_]/g, '');
            file = 'assets/sounds/words/'+s+'.mp3';
            if(bee.word_audio === false) {
                bee.word_audio = new Audio(audio.success[0].file);
                bee.word_audio.volume = 1;
            }
            try {
                bee.word_audio.src = file;
                bee.word_audio.play();
            } catch(e) {
                console.log("Error during play_word", e);
            }
        }

        
        function process_keypress(event) {
            event.preventDefault = true;
            
            if((event.keyCode >= 65 && event.keyCode <= 90) || event.keyCode == 32) { // a-z, space
                if(!bee.can_type) { playme('notavail'); return; }
                if(bee.typed.length < bee.processed_word.to_type.length) {
                    bee.typed += event.key;
                    update_input_field();
                    
                    if(bee.typed.toLowerCase() == bee.processed_word.to_type.toLowerCase()) { // Success!
                        bee.can_type = false;
                        store_question(undefined);
                        bee.$input.addClass('success');
                        success_common();
                        
                        if(bee.help_asked == 0) {
                            add_known_word(bee.processed_word.to_type);
                        }
                        
                        if(typeof(bee_local) !== 'undefined' && bee_local.success_hook) {
                            bee_local.success_hook(bee.word_ix, words[bee.word_ix][1], bee.player, bee.help_asked, -1);
                        }
                    }
                }
                return false;
            }
            
            if(event.keyCode == 8) { // backspace
                if(!bee.can_type) { playme('notavail'); return false; }
                if(bee.typed.length > 0) {
                    bee.typed = bee.typed.substring(0, bee.typed.length-1);
                    update_input_field();
                }
                return false;
            }
                       
            if(event.keyCode == 112 || event.keyCode == 113 || event.keyCode == 27 || event.keyCode == 192 || event.keyCode == 49) { // F1, F2, ESC, pipe, 1
                if(!bee.can_type) { return false; }
                if(!bee.can_use_help) { playme('notavail'); return false; }
                show_help(false);
                return false;
            }
            
            if(event.keyCode == 50) {
                if(!bee.can_type) { playme('notavail'); return false; }
                play_word(bee.processed_word.to_display);
                return false;
            }
            
            /* if(event.keyCode == 51) {
                toggle_play_music(0);
                return false;
            } */

            // console.log("key", event);
        }

        
        // Initialize a question
        function start_question(word_ix) {
            bee.word_ix = word_ix;
            bee.can_type = true;
            bee.can_use_help = true;
            if(bee.help_timeout !== false) { clearTimeout(bee.help_timeout); bee.help_timeout = false; }
            
            // Show picture
            // Ensure emoji code ends in picture modifier
            let emoji = words[word_ix][0];
            if(emoji[emoji.lenght-1] != "\ufe0f") { emoji += "\ufe0f"; }
            bee.$image.html(esc_html(emoji));
            
            // Add help & input
            bee.typed = '';
            bee.processed_word = get_processed_word(word_ix);
            bee.$help.html(render_to_html(true));
            bee.help_asked = 0;
            update_input_field();
            bee.$input.removeClass('success');
            show_help(true);
        }
        
        
        function new_question() {
            // Refresh the page periodically
            if(Date.now() - bee.load_time > 4*60*60*1000) {
                window.location.reload(true);
                return;
            }
            
            try{ document.activeElement.blur(); }catch(e){}
            
            let word_ix = get_question_from_store();
            let log = '';
            if(word_ix === undefined) {
                while(true) {
                    word_ix = Math.floor(Math.random() * words.length);
                    log += " w:"+word_ix;
                    // ensure we choose a new word
                    if(bee.word_ix !== false && word_ix == bee.word_ix) { log += ' norep'; continue; }
                    // Avoid already known words (typed without help)
                    const procword = get_processed_word(word_ix);
                    const known_count = is_known_word(procword.to_type);
                    log += " k:"+known_count;
                    if(known_count == 2 && Math.random() < .5) { log += ' no2'; continue; }
                    if(known_count > 2 && Math.random() < .8) { log += ' no2+'; continue; }
                    if(known_count > 5 && Math.random() < .95) { log += ' no5+'; continue; }
                    break;
                }
            } else {
                log += ' from store';
            }
            console.log("Selecting new word:", log);
            store_question(word_ix);
            start_question(word_ix);
        }
        
        
        // Choose a range of word sets to show words from
        function choose_wordsets() {
            const num_wordsets = word_sets.length - 1;
            let min_wordset = prompt("What range of word sets should we use?\nType a number from 0 to "+num_wordsets+" (simple to difficult) for the bottom end of the range") - 0;
            if(isNaN(min_wordset)) { min_wordset = 0; }
            let max_wordset = prompt("Type a number from "+min_wordset+" to "+num_wordsets+" (simple to difficult) for the top end of the range") - 0;
            if(isNaN(max_wordset)) { max_wordset = 0; }
            return [min_wordset, max_wordset];
        }
        
        
        function init_wordlist() {
            words = [];
            min_wordset = bee.storage.players[bee.player].min_wordset;
            if(min_wordset === undefined) { min_wordset = 0; }
            max_wordset = bee.storage.players[bee.player].wordsets;
            for(let i=min_wordset; i<=max_wordset; i++) {
                words = words.concat(word_sets[i]);
            }
            $('.d_wordsets').html(
                esc_html(min_wordset) + " to " + 
                esc_html(max_wordset) + " (" + words.length + " words)"
            );
        }
        
        
        // Prevent getting a new question when the page is refreshed
        function store_question(word_ix) {
            bee.storage.players[bee.player].current_question = word_ix;
            save_storage('store_question');
        }
        
        function get_question_from_store() {
            const w = bee.storage.players[bee.player].current_question;
            if(w === undefined) { return undefined; }
            if(w >= words.length) { return undefined; }
            return w;
        }
        
        
        function modify_wordlist() {
            if(bee.player === false) { alert("Choose a player first"); return; }
            const wordsets = choose_wordsets();
            bee.storage.players[bee.player].min_wordset = wordsets[0];
            bee.storage.players[bee.player].wordsets = wordsets[1];
            save_storage('modify_wordlist');
            init_wordlist();
            new_question();
        }
        
        
        function main() {
            document.addEventListener('keydown', process_keypress); // Or use 'keypress' event

            update_score_ui(false);
            $('.d_player').html(esc_html(bee.player));
            init_wordlist();
            new_question();
        }
        
        
        // Start menu - render
        // Audio can only be played after a user event on the page, so we require a click
        menu = "<p>Choose player</p>";
        for (const [key, value] of Object.entries(bee.storage.players)) {
            menu += '<div class="startbutton" data-player="'+esc_html(key)+'">'+esc_html(key)+'</div>';
        }
        menu += '<div class="startbutton" data-playernew="1">New user<br><span style="font-size:60%">All player data is stored in the browser only</span></div>';
        $('.game').hide();
        $('.startmenu').html(menu);
        
        // Start menu - logic
        setTimeout(function() {  // allow time for rendering
            $('.startbutton').on('click', function() {
                
                if($(this).data('playernew')) {
                    bee.player = prompt("What is the name of the player?");
                    if(bee.player === null || bee.player === '') { return false; }

                    // Initialize
                    if(!bee.storage.players[bee.player]) {
                        const wordsets = choose_wordsets();
                        bee.storage.players[bee.player] = {'score': 0, 'min_wordset': wordsets[0], 'wordsets': wordsets[1]};
                        save_storage('init');
                    } else {
                        alert("That player already exists. Loading player data");
                    }
                } else {
                    bee.player = $(this).data('player');
                }
                
                $('.startmenu').hide();
                $('.game').show();
                main();
                return false;
            });
        }, 200);
        
    </script>

</body>
</html>
